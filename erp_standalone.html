<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroERP Standalone</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Dependencies via ESM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "react-router-dom": "https://esm.sh/react-router-dom@7.1.3",
        "lucide-react": "https://esm.sh/lucide-react@0.474.0",
        "dexie": "https://esm.sh/dexie@4.0.10",
        "dexie-react-hooks": "https://esm.sh/dexie-react-hooks@4.0.2"
      }
    }
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .main-nav::-webkit-scrollbar { width: 4px; }
        
        /* Transition for sidebar */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased overflow-hidden">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            HashRouter, Routes, Route, Navigate, Link, useLocation, Outlet 
        } from 'react-router-dom';
        import { 
            LayoutDashboard, Users, Shield, Building2, Calculator, 
            Banknote, Truck, ShoppingCart, Network, Settings,
            ChevronRight, ChevronLeft, Database, Plus, Trash2, 
            Edit, Save, AlertCircle, FileText, RefreshCcw, Download, 
            Upload, Loader, Construction, Building, User as UserIcon, 
            CornerDownRight 
        } from 'lucide-react';
        import Dexie from 'dexie';
        import { useLiveQuery } from 'dexie-react-hooks';

        // --- DATABASE & TYPES ---
        const CenterType = {
            CENTRAL: 'Central',
            DELEGACION: 'Delegacion',
            CENTRO_ASOCIADO: 'Centro_Asociado',
            OTRO_CENTRO: 'Otro_centro'
        };

        const AccountClassification = {
            ACTIVO: 'Activo', PASIVO: 'Pasivo', CAPITAL: 'Capital', INGRESOS: 'Ingresos', COSTES: 'Costes'
        };

        const SupplierClassification = {
            SUBCONTRATISTA: 'Subcontratista', MATERIALES: 'Materiales', 
            SERVICIOS_GENERALES: 'Servicios Generales', INGENIERIA: 'Ingenieria', OTRO: 'Otro'
        };

        const dbName = localStorage.getItem('microerp_db_name') || 'MicroERP_Standalone';
        const db = new Dexie(dbName);
        db.version(1).stores({
            accounts: '++id, cuenta, subcuenta, clasificacion, timestamp',
            journalEntries: '++id, timestamp',
            suppliers: '++id, numeroProveedor, nombreProveedor, clasificacion, timestamp',
            invoices: '++id, supplierId, numeroFactura, fechaFactura, timestamp',
            centers: '++id, name, type, parentId, timestamp',
            users: '++id, username, email, roleId, timestamp',
            roles: '++id, name, timestamp'
        });

        // Seed data if empty
        db.on('populate', () => {
            db.accounts.add({ cuenta: '5700', subcuenta: '0000', descripcion: 'Caja', clasificacion: 'Activo', timestamp: new Date().toISOString() });
            db.suppliers.add({ numeroProveedor: '0001', nombreProveedor: 'Proveedor Demo', clasificacion: 'Otros', timestamp: new Date().toISOString() });
            db.centers.add({ name: 'Sede Central', type: 'Central', timestamp: new Date().toISOString() });
        });

        // --- COMMON COMPONENTS ---
        const UnderConstruction = () => (
            <div className="flex flex-col items-center justify-center min-h-[400px] bg-white rounded-xl border-2 border-dashed border-slate-200 p-12 text-center">
                <div className="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center text-amber-500 mb-6 border border-amber-100">
                    <Construction size={40} />
                </div>
                <h2 className="text-3xl font-bold text-slate-800 mb-3 tracking-tight">En Construcción</h2>
                <p className="text-slate-500 max-w-md mx-auto leading-relaxed">
                    Este módulo se encuentra actualmente en fase de desarrollo o no tiene una definición específica asignada.
                </p>
                <div className="mt-8 px-4 py-2 bg-slate-50 rounded-full text-xs font-semibold text-slate-400 uppercase tracking-widest border border-slate-100">Próximamente</div>
            </div>
        );

        const ModuleNav = ({ baseUrl, activeTab }) => {
            const tabs = [
                { id: 'maestro', label: 'Maestro' },
                { id: 'procesos', label: 'Procesos' },
                { id: 'transacciones', label: 'Transacciones' },
                { id: 'listados', label: 'Listados' },
                { id: 'informes', label: 'Informes' },
            ];
            return (
                <div className="flex gap-1 bg-slate-100 p-1.5 rounded-xl border border-slate-200 mb-8 w-fit shadow-sm overflow-x-auto">
                    {tabs.map((tab) => {
                        const isActive = activeTab === tab.id;
                        return (
                            <Link key={tab.id} to={`${baseUrl}/${tab.id}`}
                                className={`px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 whitespace-nowrap
                                ${isActive ? 'bg-white text-blue-600 shadow-sm border border-slate-200' : 'text-slate-500 hover:text-slate-800 hover:bg-slate-200/50'}`}>
                                {tab.label}
                            </Link>
                        );
                    })}
                </div>
            );
        };

        const ModuleWrapper = ({ baseUrl }) => {
            const location = useLocation();
            const activeTab = location.pathname.split('/').pop() || 'maestro';
            return (
                <div className="h-full flex flex-col">
                    <ModuleNav baseUrl={baseUrl} activeTab={activeTab} />
                    <div className="flex-1 overflow-auto"><Outlet /></div>
                </div>
            );
        };

        // --- ACCOUNTING MODULE ---
        const AccountingMaster = () => {
            const accounts = useLiveQuery(() => db.accounts.toArray());
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ subcuenta: '0000', clasificacion: 'Activo' });

            const handleSave = async () => {
                if (!formData.cuenta || !formData.descripcion) return alert('Campos obligatorios faltantes');
                const data = { ...formData, timestamp: new Date().toISOString() };
                if (formData.id) await db.accounts.update(formData.id, data);
                else await db.accounts.add(data);
                setIsEditing(false);
                setFormData({ subcuenta: '0000', clasificacion: 'Activo' });
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Calculator className="text-blue-600" /> Plan Contable</h2>
                        <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold shadow-sm"><Plus size={18} /> Nueva Cuenta</button>
                    </div>
                    {isEditing && (
                        <div className="p-6 bg-blue-50/50 border-b border-blue-100 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <input className="px-4 py-2 rounded-lg border border-slate-300" placeholder="Cuenta (4 dígs)" maxLength="4" value={formData.cuenta || ''} onChange={e => setFormData({...formData, cuenta: e.target.value})} />
                            <input className="px-4 py-2 rounded-lg border border-slate-300" placeholder="Subcuenta (4 dígs)" maxLength="4" value={formData.subcuenta || ''} onChange={e => setFormData({...formData, subcuenta: e.target.value})} />
                            <select className="px-4 py-2 rounded-lg border border-slate-300" value={formData.clasificacion} onChange={e => setFormData({...formData, clasificacion: e.target.value})}>
                                {Object.values(AccountClassification).map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <input className="md:col-span-2 px-4 py-2 rounded-lg border border-slate-300" placeholder="Descripción" value={formData.descripcion || ''} onChange={e => setFormData({...formData, descripcion: e.target.value})} />
                            <div className="flex justify-end gap-3 items-center">
                                <button onClick={() => setIsEditing(false)} className="text-slate-500 font-bold">Cancelar</button>
                                <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Guardar</button>
                            </div>
                        </div>
                    )}
                    <table className="min-w-full divide-y divide-slate-200">
                        <thead className="bg-slate-50">
                            <tr>
                                <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Cuenta</th>
                                <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Descripción</th>
                                <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Clasificación</th>
                                <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-slate-100">
                            {accounts?.map(acc => (
                                <tr key={acc.id} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-6 py-4 font-mono font-bold text-slate-700">{acc.cuenta}-{acc.subcuenta}</td>
                                    <td className="px-6 py-4 font-medium text-slate-800">{acc.descripcion}</td>
                                    <td className="px-6 py-4"><span className="px-2 py-1 bg-blue-50 text-blue-600 rounded text-[10px] font-bold uppercase">{acc.clasificacion}</span></td>
                                    <td className="px-6 py-4 text-right">
                                        <button onClick={() => { setFormData(acc); setIsEditing(true); }} className="text-blue-500 p-2"><Edit size={16}/></button>
                                        <button onClick={() => db.accounts.delete(acc.id)} className="text-red-400 p-2"><Trash2 size={16}/></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const AccountingProcess = () => {
            const accounts = useLiveQuery(() => db.accounts.toArray());
            const [lines, setLines] = useState([{ accountId: '', descripcion: '', valor: 0 }, { accountId: '', descripcion: '', valor: 0 }]);
            
            const total = lines.reduce((s, l) => s + (Number(l.valor) || 0), 0);
            const isBalanced = Math.abs(total) < 0.001;

            const handleSaveEntry = async () => {
                if (!isBalanced) return alert('Descuadrado');
                const entry = {
                    timestamp: new Date().toISOString(),
                    lines,
                    totalDebit: lines.filter(l => l.valor > 0).reduce((s, l) => s + Number(l.valor), 0),
                    totalCredit: Math.abs(lines.filter(l => l.valor < 0).reduce((s, l) => s + Number(l.valor), 0))
                };
                await db.journalEntries.add(entry);
                alert('Asiento grabado');
                setLines([{ accountId: '', descripcion: '', valor: 0 }, { accountId: '', descripcion: '', valor: 0 }]);
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div className="px-6 py-5 bg-slate-900 text-white font-bold flex gap-2"><Calculator /> Grabar Entrada</div>
                    <div className="p-6 space-y-4">
                        {lines.map((line, idx) => (
                            <div key={idx} className="flex gap-4 items-center bg-slate-50 p-3 rounded-lg">
                                <select className="flex-1 p-2 rounded border" value={line.accountId} onChange={e => {
                                    const nl = [...lines]; nl[idx].accountId = e.target.value; setLines(nl);
                                }}>
                                    <option value="">Seleccionar...</option>
                                    {accounts?.map(a => <option key={a.id} value={a.id}>{a.cuenta} - {a.descripcion}</option>)}
                                </select>
                                <input className="flex-1 p-2 rounded border" placeholder="Concepto" value={line.descripcion} onChange={e => {
                                    const nl = [...lines]; nl[idx].descripcion = e.target.value; setLines(nl);
                                }} />
                                <input className="w-32 p-2 rounded border text-right font-mono" type="number" step="0.01" value={line.valor} onChange={e => {
                                    const nl = [...lines]; nl[idx].valor = e.target.value; setLines(nl);
                                }} />
                                <button onClick={() => setLines(lines.filter((_, i) => i !== idx))}><Trash2 size={16} className="text-red-400" /></button>
                            </div>
                        ))}
                        <button onClick={() => setLines([...lines, { accountId: '', descripcion: '', valor: 0 }])} className="text-blue-600 font-bold">+ Añadir</button>
                        <div className={`p-4 rounded-lg flex justify-between items-center ${isBalanced ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                            <span className="font-bold">Total Balance: {total.toFixed(2)} €</span>
                            <button onClick={handleSaveEntry} disabled={!isBalanced} className={`px-6 py-2 rounded-lg font-bold text-white ${isBalanced ? 'bg-blue-600' : 'bg-slate-300'}`}>Grabar Asiento</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AccountingTransactions = () => {
            const entries = useLiveQuery(() => db.journalEntries.orderBy('timestamp').reverse().toArray());
            return (
                <div className="space-y-6">
                    {entries?.map(e => (
                        <div key={e.id} className="bg-white border rounded-xl overflow-hidden shadow-sm">
                            <div className="bg-slate-50 p-3 flex justify-between text-xs font-bold text-slate-500 border-b uppercase">
                                <span>Asiento #{e.id}</span>
                                <span>{new Date(e.timestamp).toLocaleString()}</span>
                            </div>
                            <table className="w-full text-sm">
                                <tbody>
                                    {e.lines.map((l, i) => (
                                        <tr key={i} className="border-b last:border-0">
                                            <td className="p-3 font-medium">{l.accountId}</td>
                                            <td className="p-3 italic text-slate-500">{l.descripcion}</td>
                                            <td className="p-3 text-right font-mono">{l.valor > 0 ? l.valor.toFixed(2) : '-'}</td>
                                            <td className="p-3 text-right font-mono">{l.valor < 0 ? Math.abs(l.valor).toFixed(2) : '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ))}
                </div>
            );
        };

        // --- FINANCE MODULE ---
        const FinanceMaster = () => {
            const suppliers = useLiveQuery(() => db.suppliers.toArray());
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ clasificacion: 'Otro' });

            const handleSave = async () => {
                const data = { ...formData, timestamp: new Date().toISOString() };
                if (formData.id) await db.suppliers.update(formData.id, data);
                else await db.suppliers.add(data);
                setIsEditing(false);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-emerald-50/50">
                        <h2 className="text-xl font-bold text-emerald-800 flex gap-2"><Banknote /> Maestro Proveedores</h2>
                        <button onClick={() => setIsEditing(true)} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm shadow-emerald-100">+ Nuevo</button>
                    </div>
                    {isEditing && (
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-emerald-100 bg-emerald-50/30">
                            <input className="p-2 border rounded" placeholder="Nº Prov (4 dígs)" value={formData.numeroProveedor || ''} onChange={e => setFormData({...formData, numeroProveedor: e.target.value})} />
                            <input className="p-2 border rounded" placeholder="Nombre Comercial" value={formData.nombreProveedor || ''} onChange={e => setFormData({...formData, nombreProveedor: e.target.value})} />
                            <div className="md:col-span-2 flex justify-end gap-3 mt-2">
                                <button onClick={() => setIsEditing(false)}>Cancelar</button>
                                <button onClick={handleSave} className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold">Guardar</button>
                            </div>
                        </div>
                    )}
                    <table className="min-w-full text-sm">
                        <thead className="bg-slate-50">
                            <tr className="text-left font-bold text-slate-500 uppercase text-[10px]">
                                <th className="p-4">Código</th>
                                <th className="p-4">Nombre</th>
                                <th className="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {suppliers?.map(s => (
                                <tr key={s.id}>
                                    <td className="p-4 font-mono font-bold">{s.numeroProveedor}</td>
                                    <td className="p-4">{s.nombreProveedor}</td>
                                    <td className="p-4 text-right">
                                        <button onClick={() => { setFormData(s); setIsEditing(true); }} className="text-blue-500 px-2"><Edit size={16}/></button>
                                        <button onClick={() => db.suppliers.delete(s.id)} className="text-red-400 px-2"><Trash2 size={16}/></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const FinanceProcess = () => {
            const suppliers = useLiveQuery(() => db.suppliers.toArray());
            const [formData, setFormData] = useState({ valor: 0 });

            const handleSave = async () => {
                const supplier = suppliers.find(s => s.id == formData.supplierId);
                await db.invoices.add({
                    ...formData, supplierName: supplier?.nombreProveedor, timestamp: new Date().toISOString()
                });
                alert('Factura grabada');
                setFormData({ valor: 0 });
            };

            return (
                <div className="max-w-xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                    <div className="bg-emerald-600 p-8 text-white text-center">
                        <FileText size={40} className="mx-auto mb-2 opacity-80" />
                        <h2 className="text-2xl font-bold">Registro de Factura</h2>
                    </div>
                    <div className="p-8 space-y-4">
                        <select className="w-full p-4 bg-slate-50 border rounded-xl font-bold" value={formData.supplierId || ''} onChange={e => setFormData({...formData, supplierId: e.target.value})}>
                            <option value="">-- Seleccionar Proveedor --</option>
                            {suppliers?.map(s => <option key={s.id} value={s.id}>{s.nombreProveedor}</option>)}
                        </select>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="p-4 border rounded-xl font-bold" placeholder="Nº Factura" value={formData.numeroFactura || ''} onChange={e => setFormData({...formData, numeroFactura: e.target.value})} />
                            <input className="p-4 border rounded-xl font-bold" type="date" value={formData.fechaFactura || ''} onChange={e => setFormData({...formData, fechaFactura: e.target.value})} />
                        </div>
                        <div className="bg-emerald-50 p-6 rounded-2xl border-2 border-emerald-100 flex flex-col items-center">
                            <span className="text-[10px] font-bold text-emerald-600 uppercase mb-2">Importe Total</span>
                            <input className="w-full text-center text-3xl font-black text-emerald-800 bg-transparent outline-none" type="number" step="0.01" value={formData.valor} onChange={e => setFormData({...formData, valor: e.target.value})} />
                        </div>
                        <button onClick={handleSave} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold text-lg shadow-lg">Confirmar y Registrar</button>
                    </div>
                </div>
            );
        };

        // --- ADMINISTRATION MODULE ---
        const StructureView = () => {
            const centers = useLiveQuery(() => db.centers.toArray());
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ type: 'Central' });

            const handleSave = async () => {
                if (formData.id) await db.centers.update(formData.id, formData);
                else await db.centers.add({ ...formData, timestamp: new Date().toISOString() });
                setIsEditing(false);
            };

            return (
                <div className="bg-white rounded-2xl p-8 border border-slate-200">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-black text-slate-800 flex gap-2 items-center"><Building2 className="text-blue-600"/> Estructura</h2>
                        <button onClick={() => { setFormData({ type: 'Central' }); setIsEditing(true); }} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-100">+ Nuevo Centro</button>
                    </div>
                    {isEditing && (
                        <div className="mb-8 p-6 bg-slate-50 border rounded-2xl grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input className="p-3 rounded-xl border bg-white" placeholder="Nombre Centro" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} />
                            <select className="p-3 rounded-xl border bg-white font-bold" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
                                {Object.values(CenterType).map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <div className="md:col-span-2 flex justify-end gap-3 mt-2">
                                <button onClick={() => setIsEditing(false)}>Cancelar</button>
                                <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">Guardar</button>
                            </div>
                        </div>
                    )}
                    <div className="space-y-4 border-2 border-slate-50 rounded-3xl p-8 bg-slate-50/50">
                        {centers?.filter(c => !c.parentId).map(central => (
                            <div key={central.id} className="bg-white p-4 border rounded-2xl shadow-sm flex justify-between items-center group">
                                <div className="flex gap-3 items-center">
                                    <Building className="text-blue-500" />
                                    <span className="font-bold">{central.name}</span>
                                    <span className="bg-blue-50 text-blue-600 text-[10px] px-2 py-1 rounded font-bold uppercase">{central.type}</span>
                                </div>
                                <button onClick={() => { setFormData(central); setIsEditing(true); }} className="opacity-0 group-hover:opacity-100 text-slate-400"><Edit size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- CONFIG & INTEGRATION ---
        const DbConfig = () => {
            const [dbInfo, setDbInfo] = useState(null);
            const refresh = async () => {
                const info = { name: db.name, tables: [] };
                for (const t of db.tables) {
                    info.tables.push({ name: t.name, count: await t.count() });
                }
                setDbInfo(info);
            };
            useEffect(() => { refresh(); }, []);
            const reset = async () => { if(confirm('Borrar todo?')) { await db.delete(); window.location.reload(); } };
            return (
                <div className="max-w-4xl mx-auto space-y-10 py-10">
                    <div className="text-center">
                        <Database className="mx-auto text-blue-600 mb-4" size={48} />
                        <h2 className="text-3xl font-black">Persistencia de Datos</h2>
                    </div>
                    <div className="bg-white p-10 rounded-[2rem] shadow-xl border border-slate-100">
                        <div className="flex justify-between items-center mb-10">
                            <h3 className="text-xl font-black">Base de Datos: <span className="text-blue-600">{dbInfo?.name}</span></h3>
                            <button onClick={refresh} className="p-2 text-blue-500"><RefreshCcw /></button>
                        </div>
                        <div className="space-y-3">
                            {dbInfo?.tables.map(t => (
                                <div key={t.name} className="flex justify-between p-4 bg-slate-50 rounded-xl border">
                                    <span className="font-bold capitalize">{t.name}</span>
                                    <span className="bg-white px-3 py-1 rounded-full text-blue-600 font-bold border">{t.count} rec.</span>
                                </div>
                            ))}
                        </div>
                        <div className="mt-10 pt-8 border-t flex gap-4">
                            <button onClick={reset} className="flex-1 py-4 bg-red-50 text-red-600 rounded-xl font-bold uppercase tracking-widest text-xs border border-red-100">Resetear Base de Datos</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- LAYOUT & APP ---
        const Layout = ({ children }) => {
            const [collapsed, setCollapsed] = useState(false);
            const location = useLocation();
            const segments = location.pathname.split('/').filter(Boolean);
            const currentModule = segments[0] || 'Home';
            const currentSection = segments[1] || '';

            const MenuItem = ({ to, icon: Icon, label }) => {
                const isActive = location.pathname.startsWith(to);
                return (
                    <Link to={to} className={`flex items-center gap-3 px-4 py-3 transition-all duration-200 group ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'} ${collapsed ? 'justify-center' : ''}`}>
                        <Icon size={20} /> {!collapsed && <span className="font-medium whitespace-nowrap">{label}</span>}
                    </Link>
                );
            };

            return (
                <div className="flex h-screen w-full bg-slate-50 overflow-hidden">
                    <aside className={`bg-slate-900 text-slate-300 sidebar-transition flex flex-col z-20 shadow-xl ${collapsed ? 'w-16' : 'w-64'}`}>
                        <div className="h-16 flex items-center justify-between px-4 bg-slate-950 border-b border-slate-800">
                            {!collapsed && <div className="flex items-center gap-2 font-bold text-xl text-white"><span className="bg-blue-600 p-1.5 rounded-lg"><Settings size={20}/></span><span>Micro<span className="text-blue-500">ERP</span></span></div>}
                            <button onClick={() => setCollapsed(!collapsed)} className="p-1.5 rounded-lg hover:bg-slate-800 text-slate-400">{collapsed ? <ChevronRight /> : <ChevronLeft />}</button>
                        </div>
                        <nav className="flex-1 overflow-y-auto main-nav py-4">
                            <div className="px-4 mt-6 mb-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">{!collapsed && 'Administración'}</div>
                            <MenuItem to="/admin/structure" icon={Building2} label="Estructura" />
                            <MenuItem to="/admin/users" icon={Users} label="Usuarios" />
                            <MenuItem to="/admin/security" icon={Shield} label="Seguridad" />
                            <div className="px-4 mt-6 mb-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">{!collapsed && 'Módulos'}</div>
                            <MenuItem to="/modules/contabilidad" icon={Calculator} label="Contabilidad" />
                            <MenuItem to="/modules/finanzas" icon={Banknote} label="Finanzas" />
                            <MenuItem to="/modules/integracion" icon={Network} label="Integración" />
                            <div className="px-4 mt-6 mb-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">{!collapsed && 'Configuración'}</div>
                            <MenuItem to="/config/db" icon={Database} label="Base de Datos" />
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-[10px] text-slate-500 text-center font-bold">v1.0.0 Alpha</div>
                    </aside>
                    <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
                            <div className="flex items-center gap-3 text-slate-600 font-bold capitalize">
                                <LayoutDashboard size={20} className="text-blue-600" />
                                <span>{currentModule}</span> {currentSection && <><ChevronRight size={16} className="text-slate-400" /> <span className="text-slate-400 font-normal">{currentSection}</span></>}
                            </div>
                            <div className="flex items-center gap-4"><div className="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">A</div></div>
                        </header>
                        <main className="flex-1 overflow-y-auto p-6 bg-slate-50"><div className="max-w-7xl mx-auto">{children}</div></main>
                    </div>
                </div>
            );
        };

        const App = () => (
            <HashRouter>
                <Layout>
                    <Routes>
                        <Route path="/" element={<Navigate to="/admin/structure" replace />} />
                        <Route path="/admin/structure" element={<StructureView />} />
                        <Route path="/admin/users" element={<UnderConstruction />} />
                        <Route path="/admin/security" element={<UnderConstruction />} />
                        <Route path="/config/db" element={<DbConfig />} />
                        
                        <Route path="/modules/contabilidad" element={<ModuleWrapper baseUrl="/modules/contabilidad" />}>
                            <Route index element={<Navigate to="maestro" replace />} />
                            <Route path="maestro" element={<AccountingMaster />} />
                            <Route path="procesos" element={<AccountingProcess />} />
                            <Route path="transacciones" element={<AccountingTransactions />} />
                            <Route path="*" element={<UnderConstruction />} />
                        </Route>

                        <Route path="/modules/finanzas" element={<ModuleWrapper baseUrl="/modules/finanzas" />}>
                            <Route index element={<Navigate to="maestro" replace />} />
                            <Route path="maestro" element={<FinanceMaster />} />
                            <Route path="procesos" element={<FinanceProcess />} />
                            <Route path="transacciones" element={<UnderConstruction />} />
                            <Route path="*" element={<UnderConstruction />} />
                        </Route>

                        <Route path="*" element={<Navigate to="/" replace />} />
                    </Routes>
                </Layout>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
